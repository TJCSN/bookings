
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
 
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
 
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
 
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
 
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
 
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
 
    @media (max-width: 968px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
 
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
 
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
 
    .calendar-container {
      margin-bottom: 20px;
    }
 
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
 
    .calendar-header button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
 
    .calendar-header button:hover {
      background: #5568d3;
    }
 
    .calendar-header h3 {
      color: #333;
      font-size: 1.3em;
    }
 
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
 
    .calendar-day-header {
      background: #667eea;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 0.9em;
      border-radius: 5px;
    }
 
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      position: relative;
      overflow: hidden;
    }
 
    .calendar-day:hover {
      background: #f5f5f5;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
 
    .calendar-day.selected {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
 
    .calendar-day.other-month {
      color: #ccc;
      background: #fafafa;
    }
 
    .calendar-day.today {
      border: 2px solid #ff6b6b;
    }
 
    .calendar-day-number {
      font-size: 1.1em;
      margin-bottom: 5px;
    }
 
    .calendar-day-bookings {
      font-size: 0.7em;
      color: #666;
      margin-top: 5px;
    }
 
    .calendar-day.selected .calendar-day-bookings {
      color: white;
    }
 
    .booking-indicator {
      width: 4px;
      height: 4px;
      background: #ff6b6b;
      border-radius: 50%;
      display: inline-block;
      margin-right: 2px;
    }
 
    .form-group {
      margin-bottom: 15px;
    }
 
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
 
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
 
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
 
    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
 
    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      font-weight: bold;
      transition: transform 0.2s;
    }
 
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
 
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
 
    .bookings-list {
      max-height: 600px;
      overflow-y: auto;
    }
 
    .booking-item {
      background: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      position: relative;
    }
 
    .booking-item h4 {
      color: #333;
      margin-bottom: 8px;
    }
 
    .booking-item p {
      color: #666;
      font-size: 0.9em;
      margin: 3px 0;
    }
 
    .booking-item .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
    }
 
    .booking-item .delete-btn:hover {
      background: #ff5252;
    }
 
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
 
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
 
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
 
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
 
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
 
    .refresh-btn {
      background: #4CAF50;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 15px;
    }
 
    .refresh-btn:hover {
      background: #45a049;
    }
 
    .no-bookings {
      text-align: center;
      color: #999;
      padding: 40px 20px;
    }
 
    .selected-date-display {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üö§ Booking System</h1>
      <p>Select a date and book your craft</p>
    </div>
 
    <div class="main-content">
      <!-- Calendar and Booking Form -->
      <div class="card">
        <h2>üìÖ Make a Booking</h2>
       
        <div class="calendar-container">
          <div class="calendar-header">
            <button onclick="previousMonth()">‚óÄ</button>
            <h3 id="currentMonth"></h3>
            <button onclick="nextMonth()">‚ñ∂</button>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>
 
        <div id="bookingMessage" class="message"></div>
 
        <div class="selected-date-display" id="selectedDateDisplay">
          Please select a date
        </div>
 
        <form id="bookingForm" onsubmit="submitBooking(event)">
          <div class="form-group">
            <label for="name">Your Name *</label>
            <input type="text" id="name" name="name" required>
          </div>
 
          <div class="form-group">
            <label for="craft">Select Craft *</label>
            <select id="craft" name="craft" required>
              <option value="">Choose a craft</option>
              <option value="T1">T1</option>
              <option value="K1">K1</option>
              <option value="OC1">OC1</option>
            </select>
          </div>
 
          <div class="form-group">
            <label>Time Slot *</label>
            <div class="time-inputs">
              <div>
                <input type="time" id="startTime" name="startTime" required>
                <small>Start Time</small>
              </div>
              <div>
                <input type="time" id="endTime" name="endTime" required>
                <small>End Time</small>
              </div>
            </div>
          </div>
 
          <input type="hidden" id="selectedDate" name="date">
 
          <button type="submit" class="submit-btn" id="submitBtn">
            Create Booking
          </button>
        </form>
      </div>
 
      <!-- Bookings List -->
      <div class="card">
        <h2>üìã All Bookings</h2>
        <button class="refresh-btn" onclick="loadBookings(true)">üîÑ Refresh</button>
        <div class="bookings-list" id="bookingsList">
          <div class="no-bookings">Loading bookings...</div>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    // Replace with your deployed web app URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWdzeYmc9Hbz_44Qv-vYCbNsV2LeADUtks6raI4S3QFQdtckmipSdsziB4b2cb97rbgw/exec';
    const CACHE_DURATION = 2 * 60 * 1000; // 2 minutes
 
    let currentDate = new Date();
    let selectedDate = null;
    let bookingsData = [];
 
    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      renderCalendar();
      loadBookings(false);
    });
 
    // Calendar functions
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
     
      document.getElementById('currentMonth').textContent =
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
 
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
 
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
 
      // Day headers
      const dayHeaders = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        calendar.appendChild(header);
      });
 
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createDayElement(day, true, new Date(year, month - 1, day));
        calendar.appendChild(dayElement);
      }
 
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayElement = createDayElement(day, false, date);
        calendar.appendChild(dayElement);
      }
 
      // Next month days
      const remainingDays = 42 - (firstDay + daysInMonth);
      for (let day = 1; day <= remainingDays; day++) {
        const dayElement = createDayElement(day, true, new Date(year, month + 1, day));
        calendar.appendChild(dayElement);
      }
    }
 
    function createDayElement(day, isOtherMonth, date) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
     
      if (isOtherMonth) {
        dayElement.classList.add('other-month');
      }
 
      const today = new Date();
      if (date.toDateString() === today.toDateString()) {
        dayElement.classList.add('today');
      }
 
      if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
        dayElement.classList.add('selected');
      }
 
      const dateStr = formatDate(date);
      const dayBookings = bookingsData.filter(b => b.date === dateStr);
 
      dayElement.innerHTML = `
        <div class="calendar-day-number">${day}</div>
        ${dayBookings.length > 0 ? `
          <div class="calendar-day-bookings">
            ${dayBookings.map(() => '<span class="booking-indicator"></span>').join('')}
            ${dayBookings.length} booking${dayBookings.length > 1 ? 's' : ''}
          </div>
        ` : ''}
      `;
 
      dayElement.onclick = () => selectDate(date);
      return dayElement;
    }
 
    function selectDate(date) {
      selectedDate = date;
      document.getElementById('selectedDate').value = formatDate(date);
      document.getElementById('selectedDateDisplay').textContent =
        date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      renderCalendar();
    }
 
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }
 
    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }
 
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
 
    function formatTime(time24) {
      const [hours, minutes] = time24.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'pm' : 'am';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${minutes}${ampm}`;
    }
 
    // Booking functions
    async function loadBookings(forceRefresh = false) {
      const cached = localStorage.getItem('bookingsData');
      const cacheTime = localStorage.getItem('bookingsTime');
     
      if (!forceRefresh && cached && cacheTime && (Date.now() - parseInt(cacheTime)) < CACHE_DURATION) {
        console.log('Using cached bookings');
        bookingsData = JSON.parse(cached);
        renderBookings();
        renderCalendar();
        return;
      }
 
      try {
        const formData = new FormData();
        formData.append('action', 'getBookings');
 
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
 
        const data = await response.json();
        bookingsData = data.bookings || [];
       
        localStorage.setItem('bookingsData', JSON.stringify(bookingsData));
        localStorage.setItem('bookingsTime', Date.now().toString());
       
        renderBookings();
        renderCalendar();
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsList').innerHTML =
          '<div class="no-bookings">Failed to load bookings</div>';
      }
    }
 
    function renderBookings() {
      const bookingsList = document.getElementById('bookingsList');
     
      if (bookingsData.length === 0) {
        bookingsList.innerHTML = '<div class="no-bookings">No bookings yet</div>';
        return;
      }
 
      // Sort by date and time
      const sorted = [...bookingsData].sort((a, b) => {
        if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
        return a.startTime.localeCompare(b.startTime);
      });
 
      bookingsList.innerHTML = sorted.map(booking => `
        <div class="booking-item">
          <button class="delete-btn" onclick="deleteBooking('${booking.date}', '${booking.startTime}', '${booking.craft}', '${booking.name}')">
            Delete
          </button>
          <h4>${booking.name}</h4>
          <p><strong>üìÖ Date:</strong> ${new Date(booking.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</p>
          <p><strong>‚è∞ Time:</strong> ${booking.startTime} - ${booking.endTime}</p>
          <p><strong>üö§ Craft:</strong> ${booking.craft}</p>
        </div>
      `).join('');
    }
 
    async function submitBooking(event) {
      event.preventDefault();
     
      if (!selectedDate) {
        showMessage('bookingMessage', 'Please select a date first!', 'error');
        return;
      }
 
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
     
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Creating...';
 
        const formData = new FormData(document.getElementById('bookingForm'));
        formData.append('action', 'createBooking');
       
        // Convert time to 12-hour format
        const startTime = formatTime(formData.get('startTime'));
        const endTime = formatTime(formData.get('endTime'));
        formData.set('startTime', startTime);
        formData.set('endTime', endTime);
 
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
 
        const result = await response.json();
       
        if (result.success) {
          showMessage('bookingMessage', result.message, 'success');
          document.getElementById('bookingForm').reset();
         
          // Clear cache and reload
          localStorage.removeItem('bookingsData');
          localStorage.removeItem('bookingsTime');
          await loadBookings(true);
        } else {
          showMessage('bookingMessage', result.message, 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('bookingMessage', 'Submission failed. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
 
    async function deleteBooking(date, startTime, craft, name) {
      if (!confirm('Are you sure you want to delete this booking?')) {
        return;
      }
 
      try {
        const formData = new FormData();
        formData.append('action', 'deleteBooking');
        formData.append('date', date);
        formData.append('startTime', startTime);
        formData.append('craft', craft);
        formData.append('name', name);
 
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
 
        const result = await response.json();
       
        if (result.success) {
          // Clear cache and reload
          localStorage.removeItem('bookingsData');
          localStorage.removeItem('bookingsTime');
          await loadBookings(true);
        } else {
          alert(result.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete booking. Please try again.');
      }
    }
 
    function showMessage(elementId, message, type) {
      const messageDiv = document.getElementById(elementId);
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
     
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
